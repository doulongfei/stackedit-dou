# StackEdit 依赖升级说明

**升级日期**: 2024年11月30日

## 一、升级概览

本次升级主要完成了以下工作：
1. 升级核心构建工具到最新版本
2. 移除废弃和冗余的依赖
3. 修复安全漏洞
4. 重构 PWA 实现方案

---

## 二、依赖变更详情

### 2.1 升级的依赖

| 包名 | 旧版本 | 新版本 | 说明 |
|------|--------|--------|------|
| `vite` | ^6.2.2 | ^7.2.4 | 核心构建工具 |
| `@vitejs/plugin-vue` | ^5.2.1 | ^6.0.2 | Vue 3 插件 |
| `@mdit/plugin-img-size` | ^0.16.0 | ^0.22.3 | Markdown 图片尺寸插件 |
| `bezier-easing` | ^1.1.1 | ^2.1.0 | 贝塞尔曲线库 |
| `shelljs` | ^0.8.5 | ^0.10.0 | Shell 命令工具 |
| `replace-in-file` | ^6.3.5 | ^8.3.0 | 文件替换工具 |
| `rollup-plugin-visualizer` | ^5.9.0 | ^6.0.5 | 打包分析插件 |

### 2.2 移除的依赖

| 包名 | 原因 |
|------|------|
| `node-sass` | 已废弃，使用 `sass` (Dart Sass) 替代 |
| `gulp` | 项目使用 Vite 构建，不需要 gulp |
| `gulp-concat` | 随 gulp 一起移除 |
| `vite-plugin-pwa` | 与 Vite 7 存在兼容性问题，改用原生 SW |
| `vite-plugin-favicons-inject` | 与 Vite 7 存在兼容性问题 |

### 2.3 Node.js 版本要求

```json
// package.json
"engines": {
  "node": ">=18.0.0",  // 原来: 16.14.0
  "npm": ">=8.3.1"
}
```

---

## 三、安全漏洞修复

升级前存在 **11 个漏洞**（6 moderate, 5 high），主要来自 `gulp` 及其依赖链中的 `braces`、`micromatch` 等包。

升级后：**0 漏洞**

---

## 四、PWA 实现方案变更

### 4.1 变更原因

`vite-plugin-pwa` 与 Vite 7 存在兼容性问题，改为**原生 Service Worker** 实现。

### 4.2 新增文件

```
public/
├── sw.js           # Service Worker 脚本
└── manifest.json   # PWA 清单文件
```

### 4.3 功能说明

**sw.js** - Service Worker 实现：
- 缓存策略：静态资源优先缓存，API 请求网络优先
- 自动更新：检测到新版本时通知主页面
- 离线支持：缓存核心资源支持离线访问

**manifest.json** - PWA 清单：
- 应用名称、描述、图标配置
- 启动 URL、显示模式、主题色

### 4.4 main.js 相关代码

```javascript
// 注册 Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        // 检测更新
        registration.addEventListener('updatefound', () => {
          // 处理新版本
        });
      });

    // 监听 SW 发来的更新消息
    navigator.serviceWorker.addEventListener('message', async (event) => {
      if (event.data?.type === 'SW_UPDATED') {
        // 同步数据并提示用户
        await localDbSvc.sync();
        store.dispatch('notification/info', 'StackEdit中文版刚刚更新了！');
      }
    });
  });
}
```

---

## 五、配置文件变更

### 5.1 vite.config.js

移除的配置：
- `vite-plugin-pwa` 相关配置
- `vite-plugin-favicons-inject` 配置
- `terserOptions`（与 Vite 7 不兼容）

保留的配置：
- `vite-plugin-compression` (gzip 压缩)
- `rollup-plugin-visualizer` (打包分析)

### 5.2 index.html

新增 PWA 相关标签：
```html
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2c3e50">
<link rel="apple-touch-icon" href="/static/landing/logo.svg">
```

---

## 六、SCSS 现代化改造

为适配 Dart Sass 3.0.0+ 标准，本项目已完成全面的 SCSS 代码重构，消除了所有构建警告。

### 6.1 解决 `normalize-scss` 兼容性问题

由于第三方库 `normalize-scss` 尚未适配 Dart Sass 新标准，我们采取了以下措施：
1. **本地化维护**：将 `normalize-scss` 源码复制到 `src/styles/normalize-scss/`。
2. **代码升级**：
   - 将 `@import` 模块系统升级为 `@use` 和 `@forward`。
   - 替换废弃的全局函数：
     - `type-of()` → `meta.type-of()`
     - `index()` → `list.index()`
     - `unit()` → `math.unit()`
     - `unitless()` → `math.is-unitless()`
     - `ceil()` → `math.ceil()`

### 6.2 项目代码重构

对项目内所有 `.scss` 和 `.vue` 文件进行了以下重构：
1. **模块引用升级**：将所有 `@import` 替换为 `@use`。
   - 例如：`@import 'variables'` 改为 `@use 'variables' as *`。
2. **颜色函数升级**：替换了废弃的颜色操作函数。
   - `darken($color, $amount)` → `color.adjust($color, $lightness: -$amount)`
   - `lighten($color, $amount)` → `color.adjust($color, $lightness: $amount)`
   - `transparentize($color, $amount)` → `color.adjust($color, $alpha: -$amount)`
   - `mix($color1, $color2, $weight)` → `color.mix($color1, $color2, $weight)`

### 6.3 构建注意事项

由于构建过程较为消耗内存，建议在构建时增加 Node.js 内存限制：

```bash
NODE_OPTIONS="--max-old-space-size=4096" npm run build
```

---

## 七、升级后验证

### 7.1 开发环境
```bash
npm run dev
# 访问 http://localhost:5173
```

### 7.2 生产构建
```bash
npm run build
# 检查 dist 目录输出
```

### 7.3 功能检查清单

- [ ] 编辑器正常加载
- [ ] Markdown 预览正常
- [ ] 文件保存/同步正常
- [ ] Service Worker 注册成功（DevTools > Application > Service Workers）
- [ ] PWA 安装提示正常（符合条件时）
- [ ] 离线访问正常

---

## 八、回滚方案

如需回滚，执行：
```bash
git checkout HEAD~1 -- package.json package-lock.json vite.config.js src/main.js
rm -rf node_modules
npm install
```

---

## 九、未来升级建议

以下依赖有 major 版本更新，但涉及 breaking changes，建议后续评估升级：

| 包名 | 当前版本 | 最新版本 | 备注 |
|------|----------|----------|------|
| `express` | 4.x | 5.x | API 有变化 |
| `mermaid` | 10.x | 11.x | 可能有渲染差异 |
| `jest` | 29.x | 30.x | 测试配置可能需调整 |
| `stylelint` | 15.x | 16.x | 规则配置有变化 |
